<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Socket.IO Game Room Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  </head>
  <body>
    <h1>Socket.IO Game Room Test</h1>

    <div style="margin-bottom: 8px">
      <label
        >Token:
        <input
          type="text"
          id="token"
          value="INVALID_TOKEN"
          style="width: 420px"
        />
      </label>
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn">Disconnect</button>
    </div>

    <div style="margin-bottom: 8px">
      <label
        >Room ID:
        <input
          type="text"
          id="roomId"
          placeholder="e.g. 12345"
          style="width: 200px"
        />
      </label>
      <button id="subscribeBtn">Subscribe (game_room.subscribe)</button>
      <button id="unsubscribeBtn">Unsubscribe</button>
    </div>

    <pre
      id="log"
      style="background: #eee; padding: 10px; height: 340px; overflow: auto"
    ></pre>

    <script>
      let socket;

      function log(...args) {
        const pre = document.getElementById('log');
        pre.textContent +=
          args
            .map((a) => (typeof a === 'string' ? a : JSON.stringify(a)))
            .join(' ') + '\n';
        pre.scrollTop = pre.scrollHeight;
      }

      function getRoomId() {
        return document.getElementById('roomId').value?.trim();
      }

      // Connect
      document.getElementById('connectBtn').addEventListener('click', () => {
        const token = document.getElementById('token').value;

        socket = io('http://localhost:3000', {
          auth: { token: `Bearer ${token}` }, // 서버에서 Bearer 파싱한다면 "Bearer xxx" 형태로 넣기
          transports: ['websocket'], // 필요 시 제거 가능
        });

        socket.on('connect', () => log('[connect]', socket.id));
        socket.on('disconnect', (reason) => log('[disconnect]', reason));
        socket.on('exception', (err) => log('[exception]', err));
        socket.on('connect_error', (err) =>
          log('[connect_error]', err.message),
        );

        // ✅ 게임룸 입장 브로드캐스트 수신
        // 서버 퍼블리시 이벤트명: game_room.member_joined
        socket.on('game_room.member_joined', (payload) => {
          log('[game_room.member_joined]', payload);
        });

        // 참고: 계정 입장 이벤트 수신 (있다면)
        socket.on('account.entered', (payload) =>
          log('[account.entered]', payload),
        );
      });

      // Subscribe (game_room.subscribe)
      document.getElementById('subscribeBtn').addEventListener('click', () => {
        if (!socket || !socket.connected) return log('Socket is not connected');

        const roomId = getRoomId();
        if (!roomId) return log('roomId is empty');

        // 서버 게이트웨이 @SubscribeMessage('game_room.subscribe')와 일치
        socket.emit('game_room.subscribe', { roomId }, (ack) => {
          log('[subscribe ack]', ack);
        });
      });
    </script>
  </body>
</html>
